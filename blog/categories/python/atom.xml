<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Python | Personal Interview Notes]]></title>
  <link href="http://tdongsi.github.io/python/blog/categories/python/atom.xml" rel="self"/>
  <link href="http://tdongsi.github.io/python/"/>
  <updated>2018-09-29T15:20:08-07:00</updated>
  <id>http://tdongsi.github.io/python/</id>
  <author>
    <name><![CDATA[Cuong Dong-Si]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Effective Python Pt. 5: Concurrency and Parallelism]]></title>
    <link href="http://tdongsi.github.io/python/blog/2018/08/18/effective-python-pt-5-concurrency-and-parallelism/"/>
    <updated>2018-08-18T16:24:30-07:00</updated>
    <id>http://tdongsi.github.io/python/blog/2018/08/18/effective-python-pt-5-concurrency-and-parallelism</id>
    <content type="html"><![CDATA[<p>This post corresponds to Lesson 5 &ldquo;Concurrency and Parallelism&rdquo; of <a href="https://www.safaribooksonline.com/videos/effective-python/9780134175249">&ldquo;Effective Python&rdquo; course</a>.</p>

<!--more-->


<h3>Item 23: Use subprocess to manage child processes</h3>

<pre><code class="python Typical usage of subprocess module">import subprocess

proc = subprocess.Popen(
    ['echo', 'Hello World'],
    stdout=subprocess.PIPE
)
out, err = proc.communicate()
print(out.decode('utf-8'))
</code></pre>

<pre><code class="python Simple forking example">proc = subprocess.Popen(['sleep', '0.3'])
while proc.poll() is None:
    print('Working...')
    # Time consuming process
    time.sleep(0.2)

print('Exit status: %d' % proc.poll())
</code></pre>

<p>In the forking example above, note that <code>proce.poll()</code> is used to check for and obtain the status of the child process.</p>

<pre><code class="python Parallelism wtih subprocess">def run_sleep(period):
    proc = subprocess.Popen(['sleep', str(period)])
    return proc


start = time.time()
procs = []
for _ in range(10):
    proc = run_sleep(0.3)
    procs.append(proc)

for proc in procs:
    proc.communicate()

end = time.time()
print('Takes %f seconds' % (end - start))
</code></pre>

<p>In the parallisim example above, the time it takes is approximately 0.3 seconds, no matter how many processes you create.</p>

<pre><code class="python Piping data from Python data to subprocess"># You can pipe data from Python program to subprocess
# In this way, you can call other programs to run in parallel with Python process.
# Run sub-processes on multiple CPUs.
def run_openssl(data):
    """A computing-intensive method, best for running separately on separate CPUs."""
    env = os.environ.copy()
    env['password'] = b'asdf'
    proc = subprocess.Popen(
        ['openssl', 'enc', '-des3', '-pass', 'env:password'],
        env=env,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE
    )
    proc.stdin.write(data)
    proc.stdin.flush()
    return proc

procs = []
for _ in range(5):
    data = os.urandom(100)
    proc = run_openssl(data)
    procs.append(proc)

for proc in procs:
    out, _ = proc.communicate()
    print(out)
</code></pre>

<p>Note that in this piping example above, you can use <code>os.environ.copy</code> to shield current process&rsquo;s environment from modifications of its variables.
You can use the new copy of environment by specifying <code>env=my_env</code> in <code>Popen</code> constructor.
In addition, you can use the environment variable as parameters in the <code>Popen</code> command by using <code>env:password</code>.
To pipe data from Python into the subprocess, you need to set <code>stdin=subprocess.PIPE</code> and transfer data by using <code>proc.stdin.write(data)</code>.</p>

<pre><code class="python Subprocess timeout in Python 3"># Python 3 way
proc = subprocess.Popen(['sleep', '10'])
try:
    proc.communicate(timeout=0.1)
except subprocess.TimeoutExpired:
    proc.terminate()
    proc.wait()

print('Exit status', proc.poll())
</code></pre>

<p>It&rsquo;s not available in Python 2, and if you want to reproduce its functionality in Python 2, you actually have to use the <code>select</code> module and poll the input and output file descriptors of the subprocess.
It is a little bit more complicated and it&rsquo;s hard to get right.</p>

<pre><code class="python Stop-gap alternative in Python 2">class Command(object):
    """ Stop-gap alternative for subprocess's timeout in Python 3.
    Based on https://stackoverflow.com/questions/1191374/using-module-subprocess-with-timeout
    """

    def __init__(self, process):
        self.process = process

    def run(self, timeout):
        def target():
            self.process.communicate()

        thread = threading.Thread(target=target)
        thread.start()

        thread.join(timeout)
        if thread.is_alive():
            print 'Terminating process'
            self.process.terminate()
            thread.join()

        print(self.process.returncode)

proc = subprocess.Popen(['sleep', '2'])
command = Command(proc)
command.run(timeout=3)

# NOTE: the following will not work since the subprocess already ran.
# command = Command(proc)
command = Command(subprocess.Popen(['sleep', '2']))
command.run(timeout=1)
</code></pre>

<h3>Item 24: Use threads for blocking I/O, NOT for parallelism</h3>

<p>Python has the GIL, or Global Interpreter Lock.
It means that only one Python thread will ever actually run at a time.
A common mistake is to use threads to speed up a computation-intensive program in Python.
You will be usually disappointed and end up with similar, if not worse, performance.
In other words, you might find that your complicated parallel version will have similar performance as the serial one.</p>

<p>In Python, threads are good for two main use cases.
The first use case is, if you want something looks running simultaneously (concurrency).
A common example is to respond to user inputs while doing network I/O.
In this case, the threads will cooperate with each other to obtain GIL fairly.
The second use case for threads in Python is for (blocking) I/O such as network, system calls.
A common example is to use threads to query multiple REST endpoints concurrently.
The following example illustrate such use case:</p>

<pre><code class="python Use Python threads for network I/O">import threading
import requests
import time

def get_response(url):
    r = requests.get(url)
    return r.status_code, r.text

class RequestThread(threading.Thread):

    def __init__(self, url):
        super(RequestThread, self).__init__()
        self._url = url

    def run(self):
        self.output = get_response(self._url)

urls = ['https://www.google.com',
        'https://www.facebook.com',
        'https://www.apple.com',
        'https://www.netflix.com',
        'https://www.salesforce.com',
        'https://www.intuit.com',
        'https://www.amazon.com',
        'https://www.uber.com',
        'https://www.lyft.com']

threads = []
for url in urls:
    thread = RequestThread(url)
    thread.start()
    threads.append(thread)

for thread in threads:
    thread.join()
</code></pre>

<p>TODO: Explain GIL and under the cover, <code>request</code> release the control of GIL.</p>

<p>TODO: mistake</p>

<p>TODO: Note about how to call constructor.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python 3 Quick Recap]]></title>
    <link href="http://tdongsi.github.io/python/blog/2017/08/13/python-3-quick-recap/"/>
    <updated>2017-08-13T23:49:57-07:00</updated>
    <id>http://tdongsi.github.io/python/blog/2017/08/13/python-3-quick-recap</id>
    <content type="html"><![CDATA[
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Requests Cookbook]]></title>
    <link href="http://tdongsi.github.io/python/blog/2017/08/06/requests-cookbook/"/>
    <updated>2017-08-06T23:17:25-07:00</updated>
    <id>http://tdongsi.github.io/python/blog/2017/08/06/requests-cookbook</id>
    <content type="html"><![CDATA[<p><code>requests</code> module is a simple HTTP client library in Python.</p>

<!-- more -->


<h3>Example: BART parking</h3>

<p>The problem is discussed <a href="http://tdongsi.github.io/blog/2016/10/30/automated-downloading-bart-parking-permits/">here</a>.
The <code>requests</code>&rsquo;s code snippets can be found <a href="https://github.com/tdongsi/bart-parking/blob/develop/python/bart.py">here</a>.</p>

<p>Featuring:</p>

<ul>
<li>Login with CSRF protection (with POST)</li>
<li>Cookie retrieval and usage</li>
<li>Binary download and saved to file.</li>
</ul>


<pre><code class="python Different payload for POST"># POST /bart/users/login/ HTTP/1.1
# Content-Type: application/x-www-form-urlencoded
HEADERS = {"Referer": "https://www.select-a-spot.com/bart/"}
params = {"username": username,
            "password": password,
            "csrfmiddlewaretoken": r.cookies["csrftoken"],
            "login": "Login"}
r = s.post("https://www.select-a-spot.com/bart/users/login/", headers=HEADERS, data=params, allow_redirects=False)

# POST /kafka/topic HTTP/1.1
# Content-Type: application/json
my_data = {'name': IOT_TOPIC, 'type': '/types/com.prod.emp'}
my_header = {'Accept': 'application/json', 'Content-Type': 'application/json'}

logger.info('POST: %s', TOPIC_ENDPOINT)
r = s.post(TOPIC_ENDPOINT, headers=my_header, data=json.dumps(my_data), cert=KAFKA_CERTS)
</code></pre>

<p>Note that <code>json.dumps</code> is required for POST-ing JSON data. The typical service response:</p>

<pre><code class="plain Error message">"exception":"org.springframework.http.converter.HttpMessageNotReadableException","message":"Bad Request"
</code></pre>

<h3>SSL authentication</h3>

<p>You can specify your certificate and private key in <code>cert=(my_cert, my_key)</code> as a method parameter.
The certificate authority can be optionally specified (<code>s.verify = MY_CA</code>) or not (<code>s.verify = False</code>).</p>

<pre><code class="python SSL authentication">def test_kafka(my_cert, my_key):
    """ Top level function to test_kafka.

    :param my_cert: path to certificate.
    :param my_key: path to private key corresponding to the certificate.
    :return:
    """

    ZOOKEEPER_EP = 'https://kafka-prd.corp.net:9090'
    IOT_NAMESPACE = 'test'
    MY_CA = 'download/ca.crt'

    s = requests.Session()
    s.verify = MY_CA

    def test_namespace():
        """ Test querying kafka namespace.

        Basically: curl -k -E ./kafka.p12:password "https://kafka.prd:9090/namespaces/test"
        """
        NAMESPACE_PATH = '/namespaces'
        endpoint = ZOOKEEPER_EP + NAMESPACE_PATH + '/' + IOT_NAMESPACE

        logger.info('GET: %s', endpoint)
        r = s.get(endpoint, cert=(my_cert, my_key))

        logger.debug("Response: %s", r.text)
        data = json.loads(r.text)
        # print json.dumps(data, indent=4)
        # Print namespace
        logger.info("ID: %s", data['id'])
        pass

    test_namespace()
</code></pre>

<h3>Unit testing</h3>

<p>You can do unit testing by using <code>requests-mock</code> package.</p>

<pre><code class="plain Installation"># Only required for Python 2. Mock is part of Python 3.
pip install -U mock

pip install requests-mock
</code></pre>

<pre><code class="python Example of mocking">    @requests_mock.mock()    
    def test_get_env_status(self, m):
        #Test status code 400 returns False
        m.get(self.status_endpoint, status_code=404)
        with mock.patch.dict(os.environ,{'username':'mytempuser', 'password':'temppass'}):
            self.assertEquals(FlowSnakeEnvironment.get_env_status(self.fsenv_name), None)
</code></pre>

<h4>References</h4>

<ul>
<li><a href="https://media.readthedocs.org/pdf/requests-mock/latest/requests-mock.pdf">PDF doc</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tutorial: Protocols]]></title>
    <link href="http://tdongsi.github.io/python/blog/2016/09/05/tutorial-protocols/"/>
    <updated>2016-09-05T23:50:24-07:00</updated>
    <id>http://tdongsi.github.io/python/blog/2016/09/05/tutorial-protocols</id>
    <content type="html"><![CDATA[<p>Python uses &ldquo;duck typing&rdquo;.
It does not have interfaces like Java to enforce certain behaviors:
<code>Iterable</code> iterface means that you can iterate an object of that class in a <code>for each</code> loop.
In Python, to do that, you have to override magic functions like <code>__iter__</code> to achieve some behaviors.
Each behavior is called &ldquo;protocol&rdquo; in this post since some involves overriding multiple magic funtions.</p>

<!-- Reference:
Evernote: "OOP in Python"
-->




<!--more-->


<h3>Iterator</h3>

<p>Here, <code>__iter__</code> just returns self, an object that has the function next(), which (when called) either returns a value or raises a StopIteration exception.
We’ve actually already met several iterators in disguise; in particular, <code>enumerate</code> is an iterator.
To drive home the point, here’s a simple reimplementation of <code>enumerate</code>:</p>

<pre><code class="python Implement enumerator() as iterator">&gt;&gt;&gt; class my_enumerate:
...   def __init__(self, some_iter):
...      self.some_iter = iter(some_iter)
...      self.count = -1
...
...   def __iter__(self):
...      return self
...
...   def next(self):
...      val = self.some_iter.next()
...      self.count += 1
...      return self.count, val
&gt;&gt;&gt; for n, val in my_enumerate(['a', 'b', 'c']):
...   print n, val
0 a
1 b
2 c
</code></pre>

<h4>Generator and Iterator protocol</h4>

<p>It is also much easier to write routines like enumerate as a generator than as an iterator:</p>

<pre><code class="python Implement enumerate() using generator">&gt;&gt;&gt; def gen_enumerate(some_iter):
...   count = 0
...   for val in some_iter:
...      yield count, val
...      count += 1
</code></pre>

<p>But you can do things with generators that you couldn’t do with finite lists.
Consider two full implementation of Eratosthenes’ Sieve for finding prime numbers.
Full discussion is <a href="http://intermediate-and-advanced-software-carpentry.readthedocs.io/en/latest/idiomatic-python.html">here</a>.
Most of these are from &ldquo;Python tutorial&rdquo;.</p>

<h3>Container</h3>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python 2 Quick Recap]]></title>
    <link href="http://tdongsi.github.io/python/blog/2016/07/02/python-quick-recap/"/>
    <updated>2016-07-02T00:23:27-07:00</updated>
    <id>http://tdongsi.github.io/python/blog/2016/07/02/python-quick-recap</id>
    <content type="html"><![CDATA[<p>What to review before a Python interview.
This blog post focuses on Python 2.7.
Python 3 should be discussed in another blog post.</p>

<!--more-->


<h3>Basic</h3>

<ol>
<li><a href="https://docs.python.org/2.7/tutorial/">Python tutorial</a>: especially <a href="https://docs.python.org/2.7/tutorial/classes.html">&ldquo;Classes&rdquo;</a> and two <a href="https://docs.python.org/2.7/tutorial/stdlib.html">&ldquo;Brief Tour of Standard Library&rdquo;</a> sections.</li>
<li><a href="https://pyformat.info/">String format</a> if you expect lots of string processing.</li>
<li><a href="/blog/2016/09/05/tutorial-protocols/">Protocols</a>.</li>
</ol>


<h3>Python decorator</h3>

<p>Python decorator is a callable that takes a function as argument and returns a replacement function.</p>

<pre><code class="python Example decorator">&gt;&gt;&gt; def outer(some_func):
...     def inner():
...         print "before some_func"
...         ret = some_func() # 1
...         return ret + 1
...     return inner
&gt;&gt;&gt; def foo():
...     return 1
&gt;&gt;&gt; decorated = outer(foo) # 2
&gt;&gt;&gt; decorated()
before some_func
2
</code></pre>

<p>Python 2.4 provided support to wrap a function in a decorator by pre-pending the function definition with a decorator name and the @ symbol.</p>

<pre><code class="python A generic decorator">&gt;&gt;&gt; def logger(func):
...     def inner(*args, **kwargs): #1
...         print "Arguments were: %s, %s" % (args, kwargs)
...         return func(*args, **kwargs) #2
...     return inner

&gt;&gt;&gt; @logger
... def foo1(x, y=1):
...     return x * y
</code></pre>

<p>Note that decorators implemented as functions above are stateless.
For stateful decorators (e.g., counter), they should be implemented as a class (see <a href="http://scottlobdell.me/2015/04/decorators-arguments-python/">here</a>).</p>

<h4>Reference</h4>

<p>RECOMMENDED:</p>

<ul>
<li><a href="http://simeonfranklin.com/blog/2012/jul/1/python-decorators-in-12-steps/">Decorator tutorial</a></li>
<li><a href="http://scottlobdell.me/2015/04/decorators-arguments-python/">Decorator with arguments</a></li>
</ul>


<p>EXTRA READING:</p>

<ul>
<li><a href="https://github.com/yihtserns/groovy-decorator">Python-inspired decorator in Groovy</a></li>
<li><a href="https://wiki.python.org/moin/PythonDecoratorLibrary">Decorator library</a></li>
</ul>


<h3>Python generator</h3>
]]></content>
  </entry>
  
</feed>
