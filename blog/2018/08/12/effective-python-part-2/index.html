
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Effective Python Pt. 2: Comprehensions & Generators - Personal Interview Notes</title>
  <meta name="author" content="Cuong Dong-Si">

  
  <meta name="description" content="This post corresponds to Lesson 2 &ldquo;Comprehensions &amp; Generators&rdquo; of &ldquo;Effective Python&rdquo; course. Item 8: Use list &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tdongsi.github.io/python/blog/2018/08/12/effective-python-part-2/">
  <link href="/python/favicon.png" rel="icon">
  <link href="/python/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Personal Interview Notes" type="application/atom+xml">
  <link href="/python/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/python/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/python/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/python/">Personal Interview Notes</a></h1>
  
    <h2>Neither success nor failure is ever final.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="tdongsi.github.io/python">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/python/">Blog Home</a></li>
  <li><a href="/python/blog/archives">Archives</a></li>
  <li><a href="http://tdongsi.github.io/SqlTests/syllabus/">Syllabus</a></li>
  <li><a href="http://tdongsi.github.io">Personal Home</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Effective Python Pt. 2: Comprehensions & Generators</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-08-12T00:19:30-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>12:19 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This post corresponds to Lesson 2 &ldquo;Comprehensions &amp; Generators&rdquo; of <a href="https://www.safaribooksonline.com/videos/effective-python/9780134175249">&ldquo;Effective Python&rdquo; course</a>.</p>

<!--more-->


<h3>Item 8: Use list comprehension instead of MAP and FILTER</h3>

<p>List comprehension offers the more intuitive way to transform a list to another list.
Note that in Python 3, the <code>map</code> function now returns an iterator instead of a list like Python 2.
Therefore, you have to add an extra step to convert to a list.</p>

<figure class='code'><figcaption><span>List comprehension</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'><span class="c"># Recommended</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
</span><span class='line'><span class="c"># Old way: map in Python 2</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'><span class="c"># Old way: map in Python 3</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">squares</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In addition, list comprehension makes it easy to add a condition for filtering.
Using <code>filter</code> and <code>map</code>, it becomes very &ldquo;noisy&rdquo; with multiple enclosing functions and lambdas, as shown below.</p>

<figure class='code'><figcaption><span>List comprehension with filtering</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="c"># Recommended</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="c"># Old way in Python 2</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dictionary and set also have similar comprehension expressions for similar purposes.
The final note is that for very complex transformations and filtering that is not easy to pack into comprehension expressions, it is recommended to explicitly use the <code>for</code> loop instead.</p>

<h3>Item 9: Avoid more than two expressions in list comprehensions</h3>

<p>As examples, the transformations of two-dimensional matrices can be done easily with list comprehensions, as follows.</p>

<figure class='code'><figcaption><span>Transforming matrices</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
</span><span class='line'><span class="n">flatten</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">matrix</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">flatten</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">squared</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">squared</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, for 3D (or more) matrices, such approach with list comprehensions can be really hard to read.</p>

<figure class='code'><figcaption><span>3D matrix</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># 3D matrix</span>
</span><span class='line'><span class="n">matrix</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]],</span>
</span><span class='line'>    <span class="p">[[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]]</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'><span class="n">flatten</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">sublist1</span> <span class="ow">in</span> <span class="n">matrix</span>
</span><span class='line'>           <span class="k">for</span> <span class="n">sublist2</span> <span class="ow">in</span> <span class="n">sublist1</span>
</span><span class='line'>           <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sublist2</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">flatten</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As shown above, even a simple transformation of matrix flattening can make the code hard to read due to multiple levels of <code>for</code> loops.
Instead of using list comprehensions in those cases, it is recommended to explicitly use <code>for</code> loops when there are more than two expressions in such list comprehensions.</p>

<figure class='code'><figcaption><span>3D matrix</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Recommended way</span>
</span><span class='line'><span class="n">flatten</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="k">for</span> <span class="n">sublist1</span> <span class="ow">in</span> <span class="n">matrix</span><span class="p">:</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">sublist2</span> <span class="ow">in</span> <span class="n">sublist1</span><span class="p">:</span>
</span><span class='line'>        <span class="n">flatten</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sublist2</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">flatten</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another example of abusing list comprehension is to perform multiple filtering operations, such as:</p>

<figure class='code'><figcaption><span>Multiple filtering operations</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
</span><span class='line'><span class="n">filtered</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">matrix</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example, the expression performs filtering not only on rows in the matrix but also on elements in rows.
Such expressions are really hard to understand since the code is not read in the natural order of logic and flow of thoughts (see <a href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a>).
It is recommended to explicitly use <code>for</code> loops for such cases.</p>

<h3>Item 10: Consider generator expressions for large comprehensions</h3>

<p>The problems with list comprehensions are that they may create a whole new list containing all the data.
For large inputs, it can consume a significant amount of memory and can even crash your program.</p>

<p>For a (very contrived) example, let&rsquo;s say you want to return the length of each line in a file and its squares.
You can easily achieve that with the following list comprehensions.</p>

<figure class='code'><figcaption><span>List comprehension on a file</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/my_file.txt&#39;</span><span class="p">)]</span>
</span><span class='line'><span class="n">squares</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">better</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, list comprehension on a file like this is very risky.
The file can be really large or even never ending (such as a network socket).
To solve this problem, Python has generator expressions, which are a generalization of comprehensions and generators.
A generator expression gives you an iterator that you can go through that will yield one item at a time from the input and you can determine how many output items you want to return.
The above code can be rewritten as follows:</p>

<figure class='code'><figcaption><span>Generator expression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">better</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/my_file.txt&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">roots</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">better</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">roots</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">better</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">roots</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c">### Example Output</span>
</span><span class='line'><span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">44</span><span class="p">]</span>
</span><span class='line'><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">1369</span><span class="p">)</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, another powerful outcome of using generator expressions is that they can be composed together.
When you call <code>next(roots)</code>, Python goes back up to the generator expression <code>better</code>, then realizes that it has to read another line out of the file.
It has to read the line, then compute its length.
That length value is then passed back to <code>roots</code> as <code>x</code> and for computing the tuple.
What&rsquo;s surprising is that chaining generators like this actually executes very quickly in Python.
When you&rsquo;re looking for a way to compose functionallity that&rsquo;s operating on a large stream of input, generator expressions are one of the best tools for the job.</p>

<h3>Item 11: Consider generator functions instead of returning lists</h3>

<p>Let&rsquo;s say you want to find the index of every single words in a string.
The typical approach will be something as follows:</p>

<figure class='code'><figcaption><span>Typical way</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">index_words_typical</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
</span><span class='line'>        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">letter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">letter</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span>
</span></code></pre></td></tr></table></div></figure>


<p>The typical approach that returns a list of indices has a problem.
It is dense and noisy with all logistics related to <code>result</code> list: initializing the list, appending to the list whenever a result is found.
A better way to write this function is to use a generator function, with <code>yield</code> statements, as follows:</p>

<figure class='code'><figcaption><span>Better way</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">index_words</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
</span><span class='line'>        <span class="k">yield</span> <span class="mi">0</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">letter</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">letter</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
</span><span class='line'>            <span class="k">yield</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Equivalent outputs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">address</span> <span class="o">=</span> <span class="s">&#39;The quick brown fox jumps over the lazy dog&#39;</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">index_words</span><span class="p">(</span><span class="n">address</span><span class="p">)))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">index_words_typical</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Output</span>
</span><span class='line'><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the generator version of this function is much easier to read than the typical version that returns lists.
Most significantly, all of the interactions with the <code>result</code> list have been taken away.
Instead, you just have those <code>yield</code> statements, making it very obvious what is being returned.
That helps make it clear to new readers of the code.</p>

<p>The second problem of the typical approach is that it requires all results to be stored in the lists before being returned.
For huge inputs, this can cause your program to run out of memory and crash.
In contrast, the generator version of the function can handle any amount of output because it doesn&rsquo;t actually keep all of the results in memory that it found.
In the example above, if the input <code>address</code> is a huge text and you only need to display the first hundred indices, the typical approach <code>index_words_typical</code> might fail while the generator version works perfectly fine.</p>

<h3>Item 12: Be defensive when iterating over arguments</h3>

<figure class='code'><figcaption><span>Iterator as argument</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">normalize_data</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
</span><span class='line'>    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
</span><span class='line'>        <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="n">total</span>
</span><span class='line'>        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">read_visits</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>            <span class="k">yield</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Testing</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/tmp/my_numbers.txt&#39;</span>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">35</span><span class="p">]:</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">normalize_data</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">35</span><span class="p">]))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">normalize_data</span><span class="p">(</span><span class="n">read_visits</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[11.538461538461538, 61.53846153846154, 26.923076923076923]
</span><span class='line'>[]</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the output, <code>normalize_data</code> works fine with a list of numbers but it does not work when we are supplying an iterator as input.
The main reason is that we iterate multiple times with the input iterator.
After the first traversal for <code>sum</code>, the iterator is already exhausted and that explains an empty list for the output <code>result</code>.</p>

<p>The most straight-forward fix for the function <code>normalize_data</code> is probably to add a line <code>numbers = list(numbers)</code> at the beginning to materialize the iterator.
However, such fix will defeat the purpose of using iterators and the function <code>read_visits</code>: they allow handling a arbitrarily large number of inputs without committing a large working memory.</p>

<p>Another possible fix for the function <code>normalize_data</code> is as folllows:</p>

<figure class='code'><figcaption><span>Another fix</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">normalize_data_2</span><span class="p">(</span><span class="n">get_iter</span><span class="p">):</span>
</span><span class='line'>    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">get_iter</span><span class="p">())</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">get_iter</span><span class="p">():</span>
</span><span class='line'>        <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="n">total</span>
</span><span class='line'>        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span>
</span><span class='line'>
</span><span class='line'><span class="n">get_iter</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">read_visits</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">normalize_data_2</span><span class="p">(</span><span class="n">get_iter</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this approach, we recreate the iterator whenever we need to iterate the data.
So, if we need to traverse twice to normalize the data, we have to call <code>read_visits</code> twice, open the file, and read the data that many times.
The upside is that we have the correct behavior while still retaining the benefits of using iterators.
The problem of this approach is that it is very noisy and hard to read with <code>get_iter</code> and <code>lambda</code>.
A more Pythonic way to do the same thing is to use a container class for the behavior of <code>read_visits</code>, as follows:</p>

<figure class='code'><figcaption><span>Converting read_visits to a class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">ReadVisits</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>                <span class="k">yield</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">visits</span> <span class="o">=</span> <span class="n">ReadVisits</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">normalize_data</span><span class="p">(</span><span class="n">visits</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, <code>normalize_data</code> can be the same as before.
The idea is still the same, we recreate the iterator whenever we need to iterate the data.
In the example, when we iterate the <code>numbers</code> for computing <code>sum</code> or in <code>for</code> loop in <code>normalize_data</code> method, we effectively call <code>iter(numbers)</code> to retrieve the iterators.
It is defined in <code>__iter__</code> method, which will open the file and read the data whenver it is called.
However, it is much clearer and more readable than before since we encapsulate the behavior of <code>read_visits</code> method into the class <code>ReadVisits</code>.</p>

<p>Finally, one minor improvement that we can add is to validate if the input argument of <code>normalize_data</code> is a container, as opposed to plain old iterator.
If the argument is a plain old iterator, its data can be exhausted after first traversal and the <code>normalize_data</code> method will not behave correctly.
To check that, a simple check &ldquo;iter(numbers) is iter(numbers)&rdquo; will suffice.
For container-type arguments such as a list or <code>ReadVisits</code> object, each <code>iter</code> call returns a different iterator.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Cuong Dong-Si</span></span>

      




<time class='entry-date' datetime='2018-08-12T00:19:30-07:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>12:19 am</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://tdongsi.github.io/python/blog/2018/08/12/effective-python-part-2/" data-via="" data-counturl="http://tdongsi.github.io/python/blog/2018/08/12/effective-python-part-2/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/python/blog/2018/08/12/effective-python-part-1/" title="Previous Post: Effective Python Pt. 1: Expressions and Statements">&laquo; Effective Python Pt. 1: Expressions and Statements</a>
      
      
        <a class="basic-alignment right" href="/python/blog/2018/08/12/effective-python-part-3/" title="Next Post: Effective Python Pt. 3: Functions">Effective Python Pt. 3: Functions &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
    <h1>About This Blog</h1>
    <p>Random interview experience and lessons.</p>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/python/blog/2018/12/16/effective-python-part-6/">Effective Python Pt. 6: Robust Programs</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2018/08/18/effective-python-pt-5-concurrency-and-parallelism/">Effective Python Pt. 5: Concurrency and Parallelism</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2018/08/12/effective-python-part-4/">Effective Python Pt. 4: Using Classes</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2018/08/12/effective-python-part-3/">Effective Python Pt. 3: Functions</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2018/08/12/effective-python-part-2/">Effective Python Pt. 2: Comprehensions & Generators</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2018/08/12/effective-python-part-1/">Effective Python Pt. 1: Expressions and Statements</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2017/08/13/python-3-quick-recap/">Python 3 Quick Recap</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2017/08/06/requests-cookbook/">Requests Cookbook</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2016/09/17/tutorial-bfs-and-dfs/">Tutorial: BFS and DFS</a>
      </li>
    
      <li class="post">
        <a href="/python/blog/2016/09/05/tutorial-protocols/">Tutorial: Protocols</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/python/blog/categories/addepar/'>addepar (1)</a></li><li><a href='/python/blog/categories/algorithm/'>algorithm (4)</a></li><li><a href='/python/blog/categories/book/'>book (1)</a></li><li><a href='/python/blog/categories/datastructure/'>datastructure (1)</a></li><li><a href='/python/blog/categories/python/'>python (6)</a></li><li><a href='/python/blog/categories/todo/'>todo (5)</a></li><li><a href='/python/blog/categories/tutorial/'>tutorial (6)</a></li></ul>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Cuong Dong-Si -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
